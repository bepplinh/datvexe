name: Deploy to VPS

on:
  push:
    branches: [main]
  workflow_dispatch: # Cho ph√©p ch·∫°y th·ªß c√¥ng

env:
  BACKEND_PATH: /var/www/datvexe/backend
  FRONTEND_PATH: /var/www/datvexe/frontend

jobs:
  # ========================================
  # Deploy Backend (Laravel)
  # ========================================
  deploy-backend:
    name: üöÄ Deploy Backend
    runs-on: ubuntu-latest

    steps:
      - name: üì¶ Checkout code
        uses: actions/checkout@v4

      - name: üîê Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: üìã Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ secrets.VPS_PORT }} -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: üöÄ Deploy Backend
        run: |
          ssh -p ${{ secrets.VPS_PORT }} ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
            set -e
            echo "üìÅ Navigating to backend directory..."
            cd /var/www/datvexe/backend
            
            echo "üì• Pulling latest code..."
            git pull origin main
            
            echo "üì¶ Installing dependencies..."
            composer install --optimize-autoloader --no-dev --no-interaction
            
            echo "üîÑ Running migrations..."
            php artisan migrate --force
            
            echo "üßπ Clearing caches..."
            php artisan config:clear
            php artisan route:clear
            php artisan view:clear
            
            echo "üèóÔ∏è Rebuilding caches..."
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            
            echo "üîÑ Restarting queue workers..."
            php artisan queue:restart
            
            echo "‚úÖ Backend deployment completed!"
          ENDSSH

  # ========================================
  # Deploy Frontend (React/Vite)
  # ========================================
  deploy-frontend:
    name: üé® Deploy Frontend
    runs-on: ubuntu-latest

    steps:
      - name: üì¶ Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: üì• Install dependencies
        working-directory: frontend
        run: npm ci

      - name: üîß Create production env
        working-directory: frontend
        run: |
          echo "VITE_API_BASE_URL=https://api.vantaiducanh.io.vn" > .env.production

      - name: üèóÔ∏è Build frontend
        working-directory: frontend
        run: npm run build

      - name: üîê Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: üìã Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ secrets.VPS_PORT }} -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: üì§ Upload to VPS
        run: |
          # T·∫°o th∆∞ m·ª•c t·∫°m v√† upload
          ssh -p ${{ secrets.VPS_PORT }} ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "mkdir -p /var/www/datvexe/frontend/dist-new"

          # Upload dist folder
          scp -P ${{ secrets.VPS_PORT }} -r frontend/dist/* ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/var/www/datvexe/frontend/dist-new/

          # Swap folders (zero downtime)
          ssh -p ${{ secrets.VPS_PORT }} ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
            set -e
            cd /var/www/datvexe/frontend
            
            echo "üîÑ Swapping dist folders..."
            rm -rf dist-old 2>/dev/null || true
            mv dist dist-old 2>/dev/null || true
            mv dist-new dist
            
            echo "üîß Setting permissions..."
            chown -R www-data:www-data dist
            
            echo "‚úÖ Frontend deployment completed!"
          ENDSSH

  # ========================================
  # Notification (Optional)
  # ========================================
  notify:
    name: üì¢ Notify
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: always()

    steps:
      - name: üì¢ Deployment Status
        run: |
          if [ "${{ needs.deploy-backend.result }}" == "success" ] && [ "${{ needs.deploy-frontend.result }}" == "success" ]; then
            echo "‚úÖ All deployments successful!"
          else
            echo "‚ùå Some deployments failed!"
            exit 1
          fi
